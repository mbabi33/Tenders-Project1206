# parse_agency_docs.py - Справочное руководство по парсингу документов агентства

**1. Назначение:**

Этот скрипт отвечает за парсинг HTML-файлов, содержащих метаданные документов агентства и информацию о дисквалифицированных компаниях. Он извлекает детали документов (название, URL, автор, дата, статус валидности) и информацию о дисквалификациях (название компании, дата, причина), сохраняя эти данные в базе данных SQLite (`agency.db`).

**2. Зависимости:**

*   `os`: для работы с файловой системой (получение имен файлов, путей).
*   `re`: для использования регулярных выражений (извлечение ID тендера).
*   `sqlite3`: для работы с базой данных SQLite.
*   `bs4` (BeautifulSoup): для парсинга HTML-структуры.
*   `urllib.parse` (`urljoin`): для формирования полных URL.
*   `argparse`: для обработки аргументов командной строки.
*   `config`: для получения путей проекта (директории HTML, файла БД).
*   `tqdm`: для отображения прогресс-бара при обработке файлов.

**3. Использование (CLI):**

Скрипт запускается из командной строки с указанием CPV-кода и, опционально, корневой директории проекта и флага тишины.

```bash
python parse_agency_docs.py -c <CPV_CODE> [-root <ROOT_DIR>] [--silent | -s]
```

*   `-c` или `--cpv`: **Обязательный** аргумент. CPV-код, по которому будут искаться файлы.
*   `-root` или `--root-dir`: **Опциональный** аргумент. Корневая директория проекта. Если не указан, используется значение по умолчанию из `config.py`.
*   `--silent` или `-s`: **Опциональный** флаг. Отключает подробный вывод в консоль (прогресс-бар и информационные сообщения).

**Пример запуска:**
```bash
python parse_agency_docs.py -c 45200000 -root ML_DATA/
```
Или в тихом режиме:
```bash
python parse_agency_docs.py -c 45200000 -root ML_DATA/ -s
```

**4. Основные функции:**

*   `extract_tender_id(basename)`:
    *   Извлекает числовой идентификатор тендера из имени файла, используя регулярное выражение `_(\d+)_agency_docs\.html$`.

*   `parse_author_date(text)`:
    *   Парсит строку, содержащую дату и автора (например, "20.07.2024 / Giorgi").
    *   Разделяет строку по `/` или по первому пробелу, возвращая дату и автора соответственно.
    *   Возвращает `None`, если входная строка пуста или не соответствует ожидаемому формату.

*   `process_html(filepath, conn, verbose)`:
    *   Центральная функция парсинга одного HTML-файла.
    *   Извлекает `tender_id` из имени файла.
    *   Находит блок `div` с `id='agency_docs'`.
    *   **Парсинг документов:**
        *   Находит таблицу с `id='reports'` внутри `agency_docs`.
        *   Итерирует по строкам (`<tr>`) таблицы.
        *   Извлекает ссылки (`<a>`) с атрибутом `href`.
        *   Формирует полный URL документа с помощью `urljoin(config.BASE_URL, href)`.
        *   Определяет `is_invalid` (0 или 1) на основе наличия класса `obsolete1` у родительского `<td>`.
        *   Извлекает дату и автора, используя `parse_author_date`.
        *   Вставляет или игнорирует запись в таблицу `tnd_agency_docs`, устанавливая `download_status` в `'pending'`.
    *   **Парсинг дисквалификаций:**
        *   Находит `div` с `class_='ui-state-highlight'`, содержащий информацию о дисквалификациях.
        *   Итерирует по строкам таблицы внутри этого блока.
        *   Извлекает дату дисквалификации, название компании и причину.
        *   Вставляет или игнорирует запись в таблицу `tnd_disqualifications`.
    *   Фиксирует изменения в базе данных (`conn.commit()`).

*   `init_db(conn)`:
    *   Инициализирует необходимые таблицы в базе данных SQLite:
        *   **`tnd_agency_docs`**: Хранит информацию о документах.
            *   `id` (INTEGER PRIMARY KEY AUTOINCREMENT)
            *   `tender_id` (TEXT)
            *   `doc_title` (TEXT)
            *   `doc_url` (TEXT)
            *   `local_path` (TEXT) - Placeholder для локального пути после скачивания.
            *   `author` (TEXT)
            *   `date` (TEXT)
            *   `is_invalid` (INTEGER DEFAULT 0) - Флаг, указывающий на невалидность документа.
            *   `download_status` (TEXT DEFAULT 'pending') - Статус загрузки документа.
            *   `UNIQUE(tender_id, doc_url)` - Гарантирует уникальность комбинации ID тендера и URL документа.
        *   **`tnd_disqualifications`**: Хранит информацию о дисквалификациях.
            *   `id` (INTEGER PRIMARY KEY AUTOINCREMENT)
            *   `tender_id` (TEXT)
            *   `company_name` (TEXT)
            *   `disqualification_date` (TEXT)
            *   `reason` (TEXT)
            *   `UNIQUE(tender_id, company_name, disqualification_date)` - Гарантирует уникальность комбинации для предотвращения дублирования.

**5. Структура базы данных:**

*   **`tnd_agency_docs`**:
    *   `id` (INTEGER, PRIMARY KEY)
    *   `tender_id` (TEXT)
    *   `doc_title` (TEXT)
    *   `doc_url` (TEXT)
    *   `local_path` (TEXT)
    *   `author` (TEXT)
    *   `date` (TEXT)
    *   `is_invalid` (INTEGER)
    *   `download_status` (TEXT)

*   **`tnd_disqualifications`**:
    *   `id` (INTEGER, PRIMARY KEY)
    *   `tender_id` (TEXT)
    *   `company_name` (TEXT)
    *   `disqualification_date` (TEXT)
    *   `reason` (TEXT)

**6. Ключевые особенности и логика:**

*   **Парсинг URL:** Использование `urljoin` гарантирует корректное формирование абсолютных URL документов.
*   **Обработка невалидных документов:** Флаг `is_invalid` позволяет отслеживать документы, которые могут быть устаревшими или неактуальными.
*   **Статус загрузки:** Поле `download_status` с начальным значением `'pending'` предполагает будущую функциональность для автоматической загрузки документов.
*   **Уникальность записей:** Использование `INSERT OR IGNORE` и `UNIQUE` ограничений в SQL обеспечивает целостность данных, предотвращая дублирование документов и дисквалификаций.
*   **Визуализация прогресса:** Применение `tqdm` делает процесс обработки большого количества файлов более наглядным для пользователя (если не используется флаг `--silent`).
