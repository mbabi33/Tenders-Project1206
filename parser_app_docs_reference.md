# parser_app_docs.py - Справочное руководство по парсингу документов тендера (app_docs)

**1. Назначение:**

Этот скрипт предназначен для парсинга HTML-файлов, содержащих различные типы документов и информации о тендерах (`_app_docs.html`). Он умеет распознавать две основные структуры HTML-файлов: структуру вопросов и ответов (Q&A) и структуру списка файлов. Скрипт извлекает текстовые секции (например, вопросы и ответы) и метаданные связанных файлов, сохраняя их в базе данных SQLite (`docs.db`).

**2. Зависимости:**

*   `os`: для работы с файловой системой.
*   `re`: для использования регулярных выражений (извлечение ID тендера, очистка имен файлов).
*   `sqlite3`: для работы с базой данных SQLite.
*   `argparse`: для обработки аргументов командной строки.
*   `bs4` (BeautifulSoup): для парсинга HTML-структуры.
*   `tqdm`: для отображения прогресс-бара.
*   `config`: для получения стандартизированных путей проекта.

**3. Использование (CLI):**

Скрипт запускается из командной строки с указанием CPV-кода и, опционально, корневой директории проекта.

```bash
python parser_app_docs.py -c <CPV_CODE> [-root <ROOT_DIR>]
```

*   `-c` или `--cpv`: **Обязательный** аргумент. CPV-код, для которого осуществляется обработка файлов.
*   `-root` или `--root-dir`: **Опциональный** аргумент. Корневая директория проекта. Если не указан, используется значение по умолчанию из `config.py`.

**Пример запуска:**
```bash
python parser_app_docs.py -c 45200000 -root ML_DATA/
```

**4. Основные функции:**

*   `init_db(conn)`:
    *   Инициализирует базу данных SQLite по указанному соединению.
    *   Создает две таблицы (если они еще не существуют):
        *   **`tnd_app_doc_sections`**: Для хранения текстовых секций (например, вопросов/ответов).
            *   `UNIQUE(tender_db_id, section_id)` обеспечивает уникальность секции внутри тендера.
        *   **`tnd_app_doc_files`**: Для хранения метаданных о файлах.
            *   `UNIQUE(tender_db_id, section_id, file_name)` обеспечивает уникальность файла внутри секции тендера.

*   `clean_filename(name: str) -> str`:
    *   Вспомогательная функция для очистки имен файлов: заменяет спецсимволы на `_`, схлопывает множественные `_`, удаляет `_` в начале/конце.

*   `parse_qa_structure(soup, tender_code, tender_db_id, cur)`:
    *   Парсит HTML-структуру типа "Вопросы-Ответы" (Q&A).
    *   Находит все секции с классом `question`.
    *   Для каждой секции извлекает `section_id`, заголовок (`p.q`) и текстовое содержимое (`div.a`).
    *   Вставляет эти данные в таблицу `tnd_app_doc_sections`.
    *   Если в секции есть файлы (`div.answ-file`), извлекает их имена, URL и сохраняет в `tnd_app_doc_files`.

*   `parse_filelist_structure(soup, tender_code, tender_db_id, cur)`:
    *   Парсит HTML-структуру типа "Список файлов".
    *   Находит таблицу с `id='tender_docs'`.
    *   Итерирует по строкам таблицы, извлекая имя файла, URL и дату загрузки.
    *   Использует `clean_filename` для нормализации имен файлов.
    *   Вставляет метаданные файлов в таблицу `tnd_app_doc_files`.

*   `process_html_file(filepath, conn)`:
    *   Основная функция для обработки одного HTML-файла.
    *   Извлекает `tender_code` и `tender_db_id` из имени файла.
    *   Определяет тип HTML-структуры файла (наличие `section.question` или `table#tender_docs`).
    *   Вызывает соответствующую функцию парсинга (`parse_qa_structure` или `parse_filelist_structure`).
    *   Логирует предупреждения, если структура неизвестна.
    *   Фиксирует изменения в базе данных.

*   `main()`:
    *   Парсит аргументы командной строки (`-c`, `--cpv`, `-root`).
    *   Определяет пути к директории с HTML-файлами (`HTML_DIR`, поддиректория `app_docs`) и файлу базы данных (`DB_PATH`, `docs.db`) с помощью `config.get_project_paths`.
    *   Устанавливает соединение с базой данных и вызывает `init_db`.
    *   Находит все HTML-файлы, соответствующие шаблону `*_app_docs.html`.
    *   Использует `tqdm` для отображения прогресс-бара.
    *   Для каждого файла вызывает `process_html_file`, обрабатывая возможные исключения.
    *   Закрывает соединение с базой данных.

**5. Структура базы данных:**

*   **`tnd_app_doc_sections`**:
    *   `id` (INTEGER PRIMARY KEY)
    *   `tender_code` (TEXT)
    *   `tender_db_id` (INTEGER)
    *   `section_id` (TEXT)
    *   `section_title` (TEXT)
    *   `section_text` (TEXT)

*   **`tnd_app_doc_files`**:
    *   `id` (INTEGER PRIMARY KEY)
    *   `tender_code` (TEXT)
    *   `tender_db_id` (INTEGER)
    *   `section_id` (TEXT)
    *   `file_name` (TEXT)
    *   `file_url` (TEXT)
    *   `upload_date` (TEXT)
    *   `local_path` (TEXT)
    *   `download_status` (TEXT DEFAULT 'pending')

**6. Ключевые особенности и логика:**

*   **Адаптивный парсинг:** Скрипт способен адаптироваться к двум различным HTML-структурам в файлах `_app_docs.html`.
*   **Нормализация имен файлов:** Функция `clean_filename` обеспечивает стандартизацию имен файлов, что полезно для дальнейшего сохранения на диск.
*   **Метаданные файлов:** Поле `download_status` в `tnd_app_doc_files` указывает на предполагаемую возможность загрузки этих файлов в будущем.

**Важно:** В текущей версии скрипта для вывода сообщений используется функция `print()`, а не модуль `logging`. Рекомендуется унифицировать систему логирования, перейдя на модуль `logging` для соответствия стандартам проекта и обеспечения лучшей управляемости выводом.