# parse_app_bids.py - Справочное руководство по парсингу предложений (v2)

**1. Назначение:**

Скрипт `parse_app_bids.py` предназначен для извлечения информации о конкурентной борьбе в тендерах. Он анализирует файлы `_app_bids.html`, собирая данные о всех участниках, их ценовых предложениях (первом и последнем), датах подачи и итоговом ранжировании.

**2. Зависимости:**

*   `sqlite3`: СУБД для хранения результатов.
*   `bs4` (BeautifulSoup): Парсинг HTML.
*   `lxml`: Быстрый парсер XML/HTML (рекомендуется установить).
*   `tqdm`: Индикатор прогресса.
*   `config`: Модуль конфигурации проекта.

**3. Использование:**

```bash
# Запуск из виртуального окружения
python3 tender1206/parse_app_bids.py -c <CPV_CODE> [-root <ROOT_DIR>]
```

*   `-c 45200000`: Код CPV (обязательно).

**4. База данных (`bids.db`):**

Скрипт создает 3 нормализованные таблицы:

### 4.1. `tenders`
Хранит реестр обработанных тендеров.
*   `application_id` (PK)
*   `tender_number` (напр. "NAT24...")
*   `file_name`

### 4.2. `bidders`
Справочник компаний-участников.
*   `bidder_id` (PK, из системы)
*   `bidder_name` (Название компании)

### 4.3. `bids`
Связующая таблица предложений.
*   `application_id` (FK)
*   `bidder_id` (FK)
*   `last_offer_amount` / `last_offer_date`: Данные финального предложения.
*   `first_offer_amount` / `first_offer_date`: Данные начального предложения.
*   `offer_count`: Количество шагов (понижений цены).
*   `rank`: Итоговое место (1 = победитель по цене).

**5. Логика работы:**

1.  **Инициализация:** Создает структуру БД.
2.  **Поиск файлов:** Сканирует папку `app_bids` на наличие файлов `pg_*_app_bids.html`.
3.  **Обработка:**
    *   Парсит HTML с помощью `lxml`.
    *   Находит таблицу `ktable`.
    *   Для каждой строки извлекает ID и имя участника.
    *   Очищает суммы от форматирования (удаляет `` ` ``, `,`, `&nbsp;`).
    *   Преобразует даты в ISO формат (`YYYY-MM-DD HH:MM:SS`).
    *   Вычисляет ранг участника путем сортировки списка предложений по возрастанию финальной цены.
4.  **Сохранение:** Использует `INSERT OR IGNORE` для справочников и `INSERT OR REPLACE` для таблицы фактов.

**6. Особенности:**

*   Автоматически определяет отсутствие таблицы предложений (пустой тендер).
*   Корректно обрабатывает сложные форматы чисел с обратными кавычками.
*   Устойчив к незначительным изменениям верстки (использует поиск по классам и вложенности).