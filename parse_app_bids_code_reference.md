### `parse_app_bids.py` - Скрипт парсинга предложений по тендерам

**1. Назначение:**

Этот скрипт отвечает за парсинг HTML-файлов, содержащих информацию о предложениях, сделанных участниками в рамках тендеров. Он извлекает данные о каждом предложении (включая участника, сумму, дату предложения, количество предложений и итоговый ранг) и сохраняет их в базе данных SQLite.

**2. Зависимости:**

*   `sqlite3`: для работы с базой данных SQLite.
*   `bs4` (BeautifulSoup): для парсинга HTML-структуры.
*   `lxml`: парсер для BeautifulSoup.
*   `os`: для работы с файловой системой (получение имен файлов, путей).
*   `re`: для использования регулярных выражений при парсинге имен файлов и данных.
*   `argparse`: для обработки аргументов командной строки.
*   `datetime`: для работы с датами и временем.
*   `config`: для получения путей проекта.
*   `logging`: для логирования процесса выполнения скрипта.

**3. Использование (CLI):**

Скрипт запускается из командной строки с указанием CPV-кода и, опционально, корневой директории проекта.

```bash
python parse_app_bids.py -c <CPV_CODE> [-root <ROOT_DIR>]
```

*   `-c` или `--cpv`: **Обязательный** аргумент. CPV-код, по которому будут искаться файлы.
*   `-root` или `--root-dir`: **Опциональный** аргумент. Корневая директория проекта. Если не указан, используется значение по умолчанию из `config.py`.

**Пример запуска:**
```bash
python parse_app_bids.py -c 45200000 -root ML_DATA/
```

**4. Основные функции:**

*   `init_db(db_path)`:
    *   Инициализирует базу данных SQLite по указанному пути.
    *   Создает (или пересоздает, если они существуют) таблицы `tenders`, `bidders` и `bids`.
    *   **Таблица `tenders`:** `application_id` (PRIMARY KEY), `tender_number`, `file_name`.
    *   **Таблица `bidders`:** `bidder_id` (PRIMARY KEY), `bidder_name`.
    *   **Таблица `bids`:** `application_id` (FOREIGN KEY), `bidder_id` (FOREIGN KEY), `last_offer_amount`, `last_offer_datetime`, `first_offer_amount`, `first_offer_datetime`, `number_of_offers`, `final_rank`. PRIMARY KEY (`application_id`, `bidder_id`).

*   `parse_datetime(dt_str)`:
    *   Принимает строку с датой и временем в формате `DD.MM.YYYY HH:MM`.
    *   Конвертирует её в формат `YYYY-MM-DD HH:MM:SS`.
    *   В случае ошибки парсинга возвращает `None` и логирует предупреждение.

*   `clean_amount(amount_str)`:
    *   Очищает строку с суммой (удаляет обратные кавычки, запятые, пробелы).
    *   Конвертирует её в число с плавающей точкой (`float`).
    *   Возвращает `0.0` для пустых строк.

*   `parse_bids_file(file_path, db_path)`:
    *   Основная функция парсинга одного HTML-файла.
    *   Извлекает ID тендера и префикс из имени файла с помощью регулярного выражения `pg_([A-Z]{3})(\d+)_(\d+)_app_bids\.html`.
    *   Записывает информацию о тендере (ID, номер, имя файла) в таблицу `tenders`.
    *   Парсит HTML-таблицу (`class_='ktable'`) для извлечения данных о предложениях.
    *   Обрабатывает случаи, когда таблицы или строки с предложениями отсутствуют.
    *   Извлекает информацию о каждом участнике и его предложении.
    *   Вычисляет `final_rank` на основе суммы последнего предложения.
    *   Сохраняет данные участников и предложений в таблицы `bidders` и `bids`.
    *   Использует логирование для отслеживания прогресса и ошибок.

*   `main()`:
    *   Парсит аргументы командной строки (`-c`, `-root`).
    *   Определяет пути к базе данных и HTML-файлам с помощью `config.get_project_paths`.
    *   Инициализирует базу данных.
    *   Находит все HTML-файлы, соответствующие шаблону `*_app_bids.html`.
    *   Перебирает найденные файлы, вызывая `parse_bids_file` для каждого.
    *   Обрабатывает ошибки при парсинге отдельных файлов, логируя их.
    *   Выводит итоговую статистику парсинга.

**5. Структура базы данных:**

*   **`tenders`**:
    *   `application_id` (INTEGER, PRIMARY KEY)
    *   `tender_number` (TEXT)
    *   `file_name` (TEXT)

*   **`bidders`**:
    *   `bidder_id` (INTEGER, PRIMARY KEY)
    *   `bidder_name` (TEXT)

*   **`bids`**:
    *   `application_id` (INTEGER, FOREIGN KEY referencing `tenders.application_id`)
    *   `bidder_id` (INTEGER, FOREIGN KEY referencing `bidders.bidder_id`)
    *   `last_offer_amount` (REAL)
    *   `last_offer_datetime` (TEXT)
    *   `first_offer_amount` (REAL)
    *   `first_offer_datetime` (TEXT)
    *   `number_of_offers` (INTEGER)
    *   `final_rank` (INTEGER)
    *   PRIMARY KEY (`application_id`, `bidder_id`)

**6. Ключевые улучшения и логика:**

*   **Логирование:** Заменены все `print` вызовы на `logging` для более структурированного вывода информации.
*   **Парсинг дат:** Функция `parse_datetime` теперь надежно возвращает `None` при ошибке парсинга, обеспечивая консистентность типов данных.
*   **Извлечение суммы/даты первого предложения:** Реализована более надежная логика для раздельного и корректного извлечения суммы и даты первого предложения.
*   **Регулярное выражение для имен файлов:** Улучшено регулярное выражение `r'pg_([A-Z]{3})(\d+)_(\d+)_app_bids\.html'` для точного соответствия именам файлов и правильного извлечения префикса, номера и ID тендера.

---
