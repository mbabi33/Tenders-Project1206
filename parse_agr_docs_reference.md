# parse_agr_docs.py - Справочное руководство по парсингу документов контрактов

**1. Назначение:**

Этот скрипт специализируется на парсинге HTML-файлов, содержащих информацию о заключенных контрактах (`_agr_docs.html`). Он предназначен для извлечения основных метаданных контракта, ссылок на связанные файлы контракта и информации о платежах, сохраняя эти данные в базе данных SQLite (`agr.db`).

**2. Зависимости:**

*   `sqlite3`: для работы с базой данных SQLite.
*   `os`: для работы с файловой системой.
*   `re`: для использования регулярных выражений (извлечение ID тендера, поиск ссылок).
*   `argparse`: для обработки аргументов командной строки.
*   `logging`: для структурированного вывода информации о ходе выполнения.
*   `pathlib` (`Path`): для более удобной работы с путями файлов (глобинг).
*   `urllib.parse` (`urljoin`): для формирования полных URL.
*   `bs4` (BeautifulSoup): для парсинга HTML-структуры.
*   `config`: для получения стандартизированных путей проекта.
*   `tqdm`: для отображения прогресс-бара.

**3. Использование (CLI):**

Скрипт запускается из командной строки с указанием CPV-кода и, опционально, корневой директории проекта и флага для отключения подробных логов.

```bash
python parse_agr_docs.py -c <CPV_CODE> [-root <ROOT_DIR>] [--silent | -s]
```

*   `-c` или `--cpv`: **Обязательный** аргумент. CPV-код, для которого осуществляется обработка файлов.
*   `-root` или `--root-dir`: **Опциональный** аргумент. Корневая директория проекта. Если не указан, используется значение по умолчанию из `config.py`.
*   `--silent` или `-s`: **Опциональный** флаг. Отключает подробный вывод в консоль (прогресс-бар и информационные сообщения).

**Пример запуска:**
```bash
python parse_agr_docs.py -c 45200000 -root ML_DATA/
```

**4. Основные функции:**

*   `init_database(conn)`:
    *   Инициализирует базу данных SQLite по указанному соединению.
    *   Создает три таблицы (если они еще не существуют):
        *   **`tnd_agr_doc`**: Для основных данных контракта.
        *   **`tnd_agr_files`**: Для ссылок на файлы, связанные с контрактом.
        *   **`tnd_agr_payments`**: Для информации о платежах.
    *   `UNIQUE` ограничения используются для предотвращения дублирования данных.
    *   Определены `FOREIGN KEY` для связи между таблицами `tnd_agr_files` и `tnd_agr_payments` с `tnd_agr_doc` через `tender_id`.

*   `process_html_file(html_file_path, conn)`:
    *   Обрабатывает один HTML-файл контракта.
    *   Извлекает `tender_id` из имени файла, используя регулярное выражение `pg_\w+_(\d+)_agr_docs\.html`.
    *   Парсит HTML с помощью BeautifulSoup.
    *   **Парсинг файлов:** Находит все ссылки (`<a>`), у которых `href` соответствует шаблону `files.php`. Для каждой ссылки извлекает полный URL и оригинальное имя файла, затем сохраняет их в таблицу `tnd_agr_files` со статусом `'pending'`.
    *   **Важное примечание:** В текущей версии скрипта логика для полного извлечения основных данных контракта (таблица `tnd_agr_doc`) и информации о платежах (таблица `tnd_agr_payments`) **не реализована** (отмечена как `... (логика извлечения данных, адаптированная)` и `... (логика извлечения платежей)`). Скрипт в основном фокусируется на извлечении ссылок на файлы.

*   `main()`:
    *   Парсит аргументы командной строки (`-c`, `--cpv`, `-root`, `--silent`).
    *   Определяет пути к директории с HTML-файлами (`HTML_DIR`, поддиректория `agr_docs`) и файлу базы данных (`DB_PATH`, `agr.db`) с помощью `config.get_project_paths`.
    *   Устанавливает соединение с базой данных и вызывает `init_database`.
    *   Находит все HTML-файлы, соответствующие шаблону `*agr_docs*.html` в `HTML_DIR`.
    *   Использует `tqdm` для отображения прогресс-бара при обработке файлов.
    *   Для каждого файла вызывает `process_html_file`, обрабатывая возможные исключения.
    *   Закрывает соединение с базой данных и выводит сообщения о завершении.

**5. Структура базы данных:**

*   **`tnd_agr_doc`**:
    *   `id` (INTEGER PRIMARY KEY)
    *   `tender_id` (INTEGER NOT NULL, UNIQUE)
    *   `html_file_name` (TEXT)
    *   `has_contract` (INTEGER DEFAULT 0)
    *   `contract_title` (TEXT)
    *   `contract_number` (TEXT)
    *   `contract_amount` (REAL)
    *   `contract_currency` (TEXT)
    *   `contract_start_date` (TEXT)
    *   `contract_end_date` (TEXT)
    *   `days_remaining` (INTEGER)
    *   `supplier_name` (TEXT)
    *   `created_date` (TEXT)
    *   `total_contract_amount` (REAL)

*   **`tnd_agr_files`**:
    *   `id` (INTEGER PRIMARY KEY)
    *   `tender_id` (INTEGER NOT NULL, FOREIGN KEY)
    *   `file_type` (TEXT)
    *   `file_url` (TEXT, UNIQUE)
    *   `original_filename` (TEXT)
    *   `download_status` (TEXT DEFAULT 'pending')
    *   `local_path` (TEXT)

*   **`tnd_agr_payments`**:
    *   `id` (INTEGER PRIMARY KEY)
    *   `tender_id` (INTEGER NOT NULL, FOREIGN KEY)
    *   `order_id` (INTEGER NOT NULL)
    *   `payment_amount` (REAL)
    *   `payment_date` (TEXT)
    *   `record_date` (TEXT)
    *   `payment_type` (TEXT)
    *   `UNIQUE(tender_id, payment_amount, payment_date, payment_type)`

**6. Ключевые особенности и логика:**

*   **Множественные таблицы:** Используется нормализованная схема с тремя таблицами для разделения информации о контракте, файлах и платежах, что улучшает структуру и предотвращает избыточность.
*   **Будущая загрузка файлов:** Поле `download_status` в `tnd_agr_files` указывает на предполагаемую функциональность по автоматической загрузке файлов контрактов.
*   **Прогресс-бар:** Интеграция `tqdm` для визуализации процесса обработки файлов.
*   **Использование `logging`:** Все сообщения выводятся через стандартный модуль `logging` для консистентности и управляемости вывода.

**Важно:** Как упомянуто выше, текущая реализация скрипта имеет заготовки для парсинга данных контрактов и платежей, которые еще предстоит реализовать для полного извлечения всей информации.