# parse_agr_docs.py - Справочное руководство по парсингу документов контрактов (версия 2)

**1. Назначение:**

Этот скрипт является значительно переработанной и улучшенной версией парсера контрактной документации. Он специализируется на глубоком анализе HTML-файлов `_agr_docs.html`, извлекая не только метаданные, но и полную историю платежей, изменения контракта и ссылки на прикрепленные файлы. Данные сохраняются в расширенную структуру базы данных SQLite (`agr.db`).

**2. Зависимости:**

*   `sqlite3`: для работы с базой данных SQLite.
*   `os`: для работы с файловой системой.
*   `re`: для использования сложных регулярных выражений (извлечение данных из текста).
*   `argparse`: для обработки аргументов командной строки.
*   `logging`: для структурированного вывода информации.
*   `pathlib` (`Path`): для удобной работы с путями.
*   `urllib.parse` (`urljoin`): для корректного формирования абсолютных ссылок.
*   `bs4` (BeautifulSoup): для парсинга HTML.
*   `datetime`: для стандартизации форматов времени.
*   `config`: для получения путей проекта.
*   `tqdm`: для отображения прогресс-бара.

**3. Использование (CLI):**

Скрипт запускается из командной строки с указанием CPV-кода. Требуется использование Python из виртуального окружения.

```bash
/home/nerow/projects/venv/bin/python3 tender1206/parse_agr_doc2.py -c <CPV_CODE> [-root <ROOT_DIR>]
```

*   `-c` или `--cpv`: **Обязательный** аргумент. CPV-код (например, `45200000`).
*   `-root` или `--root_dir`: **Опциональный** аргумент. Корневая директория проекта.

**Пример запуска:**
```bash
/home/nerow/projects/venv/bin/python3 tender1206/parse_agr_doc2.py -c 45200000 -root tender1206/ML_DATA
```

**4. Основные функции:**

*   `init_db(db_path)`:
    *   Инициализирует базу данных SQLite. Создает 4 связанные таблицы: `tnd_agr_doc`, `tnd_agr_payments`, `tnd_contract_changes`, `tnd_agr_files`.
*   `extract_metadata(soup, tender_id, filename, cpv_code)`:
    *   Реализует **исправленную логику** поиска поставщика. Поиск тега `<strong>` привязан к ссылке `ShowProfile`, что исключает захват лишних чисел (например, "211 дней") вместо имени компании.
    *   Парсит суммы контракта и даты, используя улучшенные функции `parse_number` и `parse_date`.
*   `extract_payments(soup, tender_id)`:
    *   Извлекает историю платежей из блока "ფაქტობრივი გადახდები". Определяет тип (аванс/оплата) и источник финансирования.
*   `extract_changes(soup, tender_id)`:
    *   Парсит блоки изменений контракта (соглашений), извлекая номера изменений, даты, новые суммы и ссылки на PDF-файлы.
*   `extract_files(soup, tender_id)`:
    *   Извлекает список всех документов из таблицы `#last_docs`, включая дату загрузки и автора.

**5. Структура базы данных:**

*   **`tnd_agr_doc`** (Метаданные контракта):
    *   `tender_id` (INTEGER PRIMARY KEY)
    *   `contract_number` (TEXT)
    *   `supplier_name` (TEXT) — *Название поставщика*
    *   `contract_amount` (REAL) — *Сумма контракта*
    *   `total_paid_amount` (REAL) — *Итоговая сумма выплат*
    *   `status` (TEXT) — *Текущий статус контракта*

*   **`tnd_agr_payments`** (История платежей):
    *   `tender_id` (FK)
    *   `amount` (REAL), `payment_date` (TEXT), `type` (TEXT), `funding_source` (TEXT)

*   **`tnd_contract_changes`** (Дополнительные соглашения):
    *   `tender_id` (FK)
    *   `change_number` (TEXT), `date` (TEXT), `amount` (REAL), `file_url` (TEXT)

*   **`tnd_agr_files`** (Прикрепленные документы):
    *   `tender_id` (FK)
    *   `name` (TEXT), `url` (TEXT, UNIQUE), `upload_date` (TEXT), `author` (TEXT)

**6. Ключевые особенности и отличия от v1:**

*   **Точность:** Устранена ошибка ложного срабатывания на числа в блоке "дней до окончания". Имя поставщика теперь определяется безошибочно.
*   **Глубина данных:** Добавлена полная поддержка платежей и изменений контракта, которые в первой версии были лишь в планах.
*   **Стандартизация:** Все URL-ссылки формируются в абсолютном виде (начинаются с `https://...`), что упрощает последующую загрузку файлов.
